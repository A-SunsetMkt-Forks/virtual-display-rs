[env]
CARGO_MAKE_EXTEND_WORKSPACE_MAKEFILE = true

[env.dev]
TARGET_PATH = "x86_64-pc-windows-msvc/debug"

[env.prod]
TARGET_PATH = "x86_64-pc-windows-msvc/release"
BUILD_FLAGS = "--release"

[tasks.build-driver]
script = ["cargo b %BUILD_FLAGS% -p virtual-display-driver"]

[tasks.sign]
dependencies = ["build-driver"]
script = [
    # Load the Visual Studio Developer environment
    "call \"%ProgramFiles%\\Microsoft Visual Studio\\2022\\Community\\VC\\Auxiliary\\Build\\vcvars64.bat\"",

    # Create a self signed certificate (only if not already done)
    "if not exist DriverCertificate.cer ( makecert -r -pe -ss PrivateCertStore -n CN=DriverCertificate DriverCertificate.cer )",

    # Sign the driver
    '''
    if defined CARGO_TARGET_DIR (
        set "target_dir=%CARGO_TARGET_DIR%"
    ) else if defined CARGO_BUILD_TARGET_DIR (
        set "target_dir=%CARGO_BUILD_TARGET_DIR%"
    ) else (
        set "target_dir=target"
    )

    set "build_target=%target_dir%/%TARGET_PATH%/virtual_display_driver.dll"

    signtool sign /a /fd SHA256 /v /s PrivateCertStore /n DriverCertificate /t http://timestamp.digicert.com %build_target%
    ''',
]

[config]
default_to_workspace = false
